services:
  event_bus:
    build:
      context: ..
      dockerfile: Dockerfile.event_bus
    container_name: event_bus
    ports:
      - "9999:9999"
    networks:
      - soc_network

  # Exemplo de serviço para o Elastic Stack
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.6
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - soc_network

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.6
    container_name: kibana
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - soc_network

  # Exemplo de serviço para o MISP
  # misp:
  #   image: misp/misp
  #   container_name: misp
  #   ports:
  #     - "8080:80"
  #   environment:
  #     - MISP_BASEURL=http://localhost:8080
  #     # Adicione outras configurações do MISP aqui
  #   networks:
  #     - soc_network

  # Exemplo de serviço para Wazuh (Manager e Indexer)
  wazuh_manager:
    image: wazuh/wazuh-manager:4.14.1
    container_name: wazuh_manager
    ports:
      - "1514:1514"
      - "514:514" # Para syslog
    environment:
      - WAZUH_REGISTRATION_ENABLED=true
      # Adicione outras configurações do Wazuh aqui
    networks:
      - soc_network

  wazuh_indexer:
    image: wazuh/wazuh-indexer:4.14.1
    container_name: wazuh_indexer
    ports:
      - "9201:9200" # Exemplo, se não usar Elastic
    environment:
      - WAZUH_REGISTRATION_ENABLED=true
      # Adicione outras configurações do Wazuh aqui
    networks:
      - soc_network

  # EDR Server
  edr_server:
    build:
      context: ../modulos_de_defesa/edr_simulado
      dockerfile: Dockerfile.server
    container_name: edr_server
    ports:
      - "8000:8000"
    volumes:
      - edr_logs:/app/edr_data.log # Mount volume for logs
    environment:
      - EVENT_BUS_HOST=event_bus
    networks:
      - soc_network
    depends_on:
      - event_bus

  # EDR Agent
  edr_agent:
    build:
      context: ../modulos_de_defesa/edr_simulado
      dockerfile: Dockerfile.agent
    container_name: edr_agent
    environment:
      - SERVER_URL=http://edr_server:8000/ingest # Agent connects to the server service name
      - EVENT_BUS_HOST=event_bus
    depends_on:
      - edr_server
      - event_bus
    networks:
      - soc_network

volumes:
  edr_logs: # Define the named volume for EDR logs

networks:
  soc_network:
    driver: bridge